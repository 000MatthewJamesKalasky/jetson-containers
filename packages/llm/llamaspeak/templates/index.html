<!DOCTYPE HTML>
<html>

	<head>
		<title>Chat Bubbles</title>
		
    
    <link rel="stylesheet" href="/static/bootstrap.css">
    <link rel="stylesheet" href="/static/chat.css">
    
		<script type='text/javascript' src="/static/jquery-3.6.3.min.js"></script>
    <script type='text/javascript' src='/static/bootstrap.bundle.min.js'></script>
    <script type='text/javascript' src='/static/websocket.js'></script>
    <script type='text/javascript' src='/static/audio.js'></script>
    
		<script type="text/javascript">
			$(function(){
				$("#submit_left").click(function() {
					var left_text = $('textarea#input_text_left').val(); // get textarea contents
					if ($('textarea#input_text_left').val() != '') { // make sure textarea is not empty
						$('#container').append('<br/><div class="message_body">'
								+ left_text +
								'</div><br/>');
						$("#input_text_left").val('');
					}
				});
			});
			
      function muteAudioInput() {  
        var button = document.getElementById('mute-audio-input');
        var toggled = button.classList.contains('active');
        console.log(`muteAudioInput(${toggled})`);
        button.innerHTML = toggled ? "Unmute Mic" : "Mute Mic";
        if( audioInputTrack != undefined )
          audioInputTrack.enabled = !toggled;
      }
      
      let sampleCount = 0;
      
      function generateAudio() {
        
        samples = new Int16Array(4800);
        const hz = 440.0;
        let time = Date.now() / 1000.0;
        
        for (i = 0; i < samples.length; i++) {
          samples[i] = Math.sin(sampleCount * (Math.sin(sampleCount/24000.0)+hz) * Math.PI * 2.0 / 48000.0) * 32767;
          sampleCount++;
        }
        onAudioOutput(samples);
      }
      
      function testWebsocketSend() {
        sendWebsocket({'abc': 123, 'def': 'xyz', 'test_array': [10, 9, 8, 7, 6, 5, 4, 3, 2, 1, 0]});
        sendWebsocket("Hello my name is ABC123", type=1);
      }
      
      function onSubmitChatMsg() {
        msg = document.getElementById('chat-message-input').value;
        console.log('submitting chat message:', document.getElementById('chat-message-input').value);
        sendWebsocket(msg, type=1);
      }
      
      window.onload = function() {
      
        connectWebsocket();
        enumerateAudioDevices();
        openAudioDevices();

        //window.setInterval(generateAudio, 100);
        //window.setInterval(testWebsocketSend, 500);
      }
		</script>
		
    
	</head>
	
	<body>
		<h2>llamaspeak</h2>
		
		<div id="chat-history-container">
			<!--<h3>Conversation</h3>-->
		</div>
		
    <br/>
    
    <div id="chat-input-container">
      <div>
        <textarea id="chat-message-input" class="form-control" rows="3"></textarea>
        <br/>
        <button id="chat-message-submit" onclick="onSubmitChatMsg()">Submit</button>
      </div>
    </div>
    
    <br/>
    
    <div>
      <label for="audio-input-select">Mic:</label>
      <select id="audio-input-select" name="audio-input-select" onclick="openAudioDevices()"></select>
    </div>
		
    <div>
      <label for="audio-output-select">Speaker:</label>
      <select id="audio-output-select" name="audio-output-select" onclick="openAudioDevices()"></select>
    </div>

    <button type="button" id="mute-audio-input" class="btn btn-primary active" data-bs-toggle="button" autocomplete="off" onclick="muteAudioInput()">Unmute Mic</button>

	</body>
</html>